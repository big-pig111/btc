<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çŒœæ¯”ç‰¹å¸æ¶¨è·Œ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ä½¿ç”¨CDNå¼•å…¥Solanaåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.8/lib/index.iife.min.js"></script>
</head>
<body class="bg-gradient-to-br from-yellow-100 to-orange-200 flex flex-col items-center justify-center min-h-screen p-4">
    <!-- é¡µé¢å†…å®¹ä¿æŒä¸å˜... -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- æœ¬åœ°æ‰˜ç®¡çš„ Solana Web3 & SPL-Token ä¾èµ–ï¼Œæ”¾åœ¨ js ç›®å½•ä¸‹å³å¯ï¼Œæ— éœ€å¤–ç½‘ -->
    <script src="./js/solana-web3.min.js"></script>
    <script src="./js/spl-token.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-yellow-100 to-orange-200 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="absolute top-4 right-6">
      <button id="connectWalletBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-semibold shadow-lg">è¿æ¥é’±åŒ…</button>
      <span id="walletAddress" class="ml-2 text-purple-800 font-mono"></span>
    </div>
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-yellow-800 mb-2 flex items-center justify-center">
        ğŸª™ çŒœæ¯”ç‰¹å¸äº”åˆ†é’Ÿåæ¶¨è·Œï¼
      </h1>
      <p class="text-lg text-yellow-700">çŒœçŒœäº”åˆ†é’Ÿåæ˜¯æ¶¨è¿˜æ˜¯è·Œï¼Œæ‹¼ä¸€æ‹¼ä½ çš„ç›´è§‰ ğŸ§ </p>
      <p id="livePrice" class="text-xl font-semibold text-green-800 mt-2">å½“å‰ BTC/USDï¼šåŠ è½½ä¸­...</p>
    </div>

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 text-center">
      <canvas id="btcChart" class="mb-6"></canvas>

      <p id="status" class="text-gray-800 text-xl mb-4">ä½ è§‰å¾—æ¥ä¸‹æ¥äº”åˆ†é’Ÿæ¯”ç‰¹å¸æ˜¯æ¶¨è¿˜æ˜¯è·Œï¼Ÿ</p>
      <div id="buttons" class="flex justify-center gap-4 mb-4">
        <button onclick="handleGuess('up')" class="bg-green-100 hover:bg-green-200 text-green-800 px-4 py-2 rounded-lg">ğŸ“ˆ æ¶¨ï¼</button>
        <button onclick="handleGuess('down')" class="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded-lg">ğŸ“‰ è·Œï¼</button>
      </div>
      <p id="countdown" class="text-xl font-medium text-yellow-800 mb-4 hidden"></p>
      <div id="resultContainer" class="hidden flex flex-col items-center">
        <p id="result" class="text-2xl font-semibold text-purple-800 mb-4"></p>
        <img id="memeImg" class="rounded-xl shadow-md w-64 h-64 object-cover mb-4" />
        <button onclick="resetGame()" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-xl">å†æ¥ä¸€å±€ ğŸ”</button>
      </div>
    </div>

    <div id="betModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 flex flex-col items-center">
        <h2 class="text-xl font-bold mb-4 text-yellow-800">é€‰æ‹©ä¸‹æ³¨ Bonk æ•°é‡</h2>
        <div class="flex flex-col gap-3 w-full">
          <button class="betOption bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg" data-amount="10000">10,000</button>
          <button class="betOption bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg" data-amount="100000">100,000</button>
          <button class="betOption bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg" data-amount="1000000">1,000,000</button>
          <button id="cancelBet" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mt-2">å–æ¶ˆ</button>
        </div>
        <p id="betError" class="text-red-600 mt-3 text-sm"></p>
      </div>
    </div>

    <script>
      let prediction = null;
      let countdown = 10;
      let timer;
      let startPrice = null;
      let isWaitingForWin = false;
      let hasRewarded = false;
      const memes = [
        "https://i.imgur.com/RsGxZ5V.gif",
        "https://i.imgur.com/jHVd0QK.gif",
        "https://i.imgur.com/3jLPB46.gif",
        "https://i.imgur.com/EV6v4lA.gif"
      ];

      let priceHistory = [];
      let chart;

      const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

      ws.onmessage = function(event) {
        const trade = JSON.parse(event.data);
        const price = parseFloat(trade.p);
        const time = new Date().toLocaleTimeString();

        document.getElementById("livePrice").textContent = `å½“å‰ BTC/USDï¼š$${price}`;
        priceHistory.push({ time, price });
        if (priceHistory.length > 30) priceHistory.shift();
        updateChart();

        console.log('isWaitingForWin:', isWaitingForWin, 'hasRewarded:', hasRewarded, 'startPrice:', startPrice, 'prediction:', prediction, 'price:', price);

        if (isWaitingForWin && !hasRewarded && startPrice !== null && prediction !== null) {
          const actual = price > startPrice ? 'up' : 'down';
          if (actual === prediction) {
            hasRewarded = true;
            showWinReward(price);
          }
        }
      };

      function updateChart() {
        if (!chart) return;
        chart.data.labels = priceHistory.map(p => p.time);
        chart.data.datasets[0].data = priceHistory.map(p => p.price);
        chart.update();
      }

      function initChart() {
        const ctx = document.getElementById('btcChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'BTC/USD 30ç§’çº¿',
              data: [],
              backgroundColor: 'rgba(255, 206, 86, 0.2)',
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 2,
              pointRadius: 0,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: false
              }
            },
            plugins: {
              legend: {
                display: true
              }
            }
          }
        });
      }

      window.onload = initChart;

      async function fetchBTCPrice() {
        try {
          const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
          const data = await res.json();
          return data.bitcoin.usd;
        } catch (e) {
          console.error("è·å–ä»·æ ¼å¤±è´¥", e);
          return null;
        }
      }

      // Bonkä»£å¸Mintåœ°å€
      const BONK_MINT = 'DezX6B5AqF5rYv3gYQ2Q1rR1Q6Xo8Xz2y1k5Q1Q1Q1Q1';
      const BET_RECEIVER = '2kvez4gd2wsS5KJNXZ1m3puqo9QuKAKKRKAArwRGcF7Q';
      let betAmount = 0;
      let betTxSig = null;
      
      // ä¸‹æ³¨å¼¹çª—ç›¸å…³
      const betModal = document.getElementById('betModal');
      const cancelBetBtn = document.getElementById('cancelBet');
      const betOptionBtns = Array.from(document.querySelectorAll('.betOption'));
      const betError = document.getElementById('betError');
      
      // ä¿®æ”¹åçš„handleGuesså‡½æ•°ï¼Œç›´æ¥è°ƒç”¨é’±åŒ…è½¬è´¦
      async function handleGuess(guess) {
        if (!walletAddress) {
          alert('è¯·å…ˆè¿æ¥é’±åŒ…');
          return;
        }
        
        // ç›´æ¥è®¾ç½®ä¸‹æ³¨é‡‘é¢ä¸º100,000 BONK
        const amount = 100000;
        
        try {
          // 1. æ„é€  SPL Token è½¬è´¦ Transaction
          const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
          const fromPubkey = new solanaWeb3.PublicKey(walletAddress);
          const toPubkey = new solanaWeb3.PublicKey(BET_RECEIVER);
          const mintPubkey = new solanaWeb3.PublicKey(BONK_MINT);

          // æŸ¥è¯¢ç”¨æˆ· Bonk è´¦æˆ·
          const fromTokenAccounts = await connection.getParsedTokenAccountsByOwner(fromPubkey, { mint: mintPubkey });
          if (!fromTokenAccounts.value.length) throw new Error('é’±åŒ…ä¸­æ²¡æœ‰ Bonk ä»£å¸');
          const fromTokenAccount = fromTokenAccounts.value[0].pubkey;

          // ç¡®ä¿æ”¶æ¬¾æ–¹ ATA
          let toTokenAccounts = await connection.getParsedTokenAccountsByOwner(toPubkey, { mint: mintPubkey });
          let toTokenAccount;
          if (toTokenAccounts.value.length) {
            toTokenAccount = toTokenAccounts.value[0].pubkey;
          } else {
            // è‹¥æ—  ATAï¼Œåˆ™ä½¿ç”¨å…³è”è´¦æˆ·åœ°å€
            toTokenAccount = await solanaSplToken.Token.getAssociatedTokenAddress(
              solanaSplToken.ASSOCIATED_TOKEN_PROGRAM_ID,
              solanaSplToken.TOKEN_PROGRAM_ID,
              mintPubkey,
              toPubkey
            );
          }

          // Bonk ç²¾åº¦ 5 ä½
          const decimals = 5;
          const realAmount = Math.floor(amount * Math.pow(10, decimals));

          // åˆ›å»ºè½¬è´¦æŒ‡ä»¤
          const transaction = new solanaWeb3.Transaction().add(
            solanaSplToken.Token.createTransferInstruction(
              solanaSplToken.TOKEN_PROGRAM_ID,
              fromTokenAccount,
              toTokenAccount,
              fromPubkey,
              [],
              realAmount
            )
          );

          // 2. é€šè¿‡ Phantom æ’ä»¶ç­¾åå¹¶å‘é€
          transaction.feePayer = fromPubkey;
          transaction.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;
          const signed = await window.solana.signAndSendTransaction(transaction);
          await connection.confirmTransaction(signed.signature, 'confirmed');

          betTxSig = signed.signature;
          betAmount = amount;
          
          // ä¸‹æ³¨æˆåŠŸåå¼€å§‹æ¸¸æˆ
          startGame(guess);
        } catch (e) {
          alert('ä¸‹æ³¨å¤±è´¥ï¼š' + (e.message || e));
          return;
        }
      }
      
      async function startGame(guess) {
        prediction = guess;
        document.getElementById('buttons').classList.add('hidden');
        document.getElementById('countdown').classList.remove('hidden');
        document.getElementById('status').textContent = 'æ­£åœ¨è·å–å½“å‰æ¯”ç‰¹å¸ä»·æ ¼...';

        startPrice = await fetchBTCPrice();

        if (startPrice === null) {
          document.getElementById('status').textContent = 'ä»·æ ¼è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
          return;
        }

        document.getElementById('status').textContent = 'å€’è®¡æ—¶ï¼š' + countdown + ' ç§’';
        updateCountdown();
        timer = setInterval(() => {
          countdown--;
          updateCountdown();
          if (countdown === 0) {
            clearInterval(timer);
            showResult();
          }
        }, 1000);
      }

      function updateCountdown() {
        document.getElementById('status').textContent = 'å€’è®¡æ—¶ï¼š' + countdown + ' ç§’';
      }

      async function showResult() {
        document.getElementById('status').textContent = 'å€’è®¡æ—¶ç»“æŸï¼Œæ­£åœ¨ç­‰å¾…ä»·æ ¼å˜åŒ–...';
        document.getElementById('countdown').classList.add('hidden');
        isWaitingForWin = true;
        hasRewarded = false;
      }

      async function showWinReward(currentPrice) {
        document.getElementById('result').textContent = 'ğŸ‰ çŒœå¯¹å•¦ï¼';
        document.getElementById('memeImg').src = getRandomMeme();
        document.getElementById('resultContainer').classList.remove('hidden');
        document.getElementById('status').textContent = `èµ·å§‹ä»·æ ¼ï¼š$${startPrice}ï¼Œå½“å‰ä»·æ ¼ï¼š$${currentPrice}`;
        setTimeout(async () => {
          const address = prompt("æ­å–œçŒœå¯¹ï¼è¯·è¾“å…¥ä½ çš„Solanaé’±åŒ…åœ°å€é¢†å–å¥–åŠ±ï¼š");
          if (address) {
            try {
              const resp = await fetch('https://ä½ çš„åç«¯æ¥å£/send-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address })
              });
              if (resp.ok) {
                alert('å¥–åŠ±å·²å‘æ”¾ï¼ˆå¦‚æœªåˆ°è´¦è¯·ç¨ç­‰ç‰‡åˆ»ï¼‰');
              } else {
                alert('å‘æ”¾å¥–åŠ±å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
              }
            } catch (e) {
              alert('å‘æ”¾å¥–åŠ±æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
          }
        }, 500);
        isWaitingForWin = false;
      }

      function resetGame() {
        prediction = null;
        countdown = 10;
        startPrice = null;
        isWaitingForWin = false;
        hasRewarded = false;
        document.getElementById('status').textContent = 'ä½ è§‰å¾—æ¥ä¸‹æ¥äº”åˆ†é’Ÿæ¯”ç‰¹å¸æ˜¯æ¶¨è¿˜æ˜¯è·Œï¼Ÿ';
        document.getElementById('buttons').classList.remove('hidden');
        document.getElementById('resultContainer').classList.add('hidden');
      }

      // é’±åŒ…è¿æ¥ç›¸å…³
      let walletAddress = null;
      const connectWalletBtn = document.getElementById('connectWalletBtn');
      const walletAddressSpan = document.getElementById('walletAddress');

      async function connectWallet() {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect();
            walletAddress = resp.publicKey.toString();
            connectWalletBtn.textContent = 'å·²è¿æ¥';
            walletAddressSpan.textContent = walletAddress.slice(0, 4) + '...' + walletAddress.slice(-4);
          } catch (err) {
            alert('é’±åŒ…è¿æ¥å¤±è´¥');
          }
        } else {
          alert('è¯·å…ˆå®‰è£…Phantomé’±åŒ…æ’ä»¶');
        }
      }
      connectWalletBtn.onclick = connectWallet;
      // é¡µé¢åŠ è½½æ—¶æ£€æµ‹æ˜¯å¦å·²è¿æ¥
      window.addEventListener('load', async () => {
        if (window.solana && window.solana.isPhantom) {
          try {
            const resp = await window.solana.connect({ onlyIfTrusted: true });
            walletAddress = resp.publicKey.toString();
            connectWalletBtn.textContent = 'å·²è¿æ¥';
            walletAddressSpan.textContent = walletAddress.slice(0, 4) + '...' + walletAddress.slice(-4);
          } catch {}
        }
      });
      
      function getRandomMeme() {
        return memes[Math.floor(Math.random() * memes.length)];
      }
    </script>
    <script>
      // ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨å…¨å±€å¯¹è±¡ solanaWeb3 å’Œ splToken
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      
      // ä¿®æ”¹è½¬è´¦å‡½æ•°ç¤ºä¾‹
      async function transferTokens() {
        try {
          const provider = window.solana;
          if (!provider) throw new Error("è¯·å®‰è£…Phantomé’±åŒ…");
          
          const fromPubkey = new solanaWeb3.PublicKey(provider.publicKey.toString());
          const toPubkey = new solanaWeb3.PublicKey('2kvez4gd2wsS5KJNXZ1m3puqo9QuKAKKRKAArwRGcF7Q');
          const mint = new solanaWeb3.PublicKey('DezX6B5AqF5rYv3gYQ2Q1rR1Q6Xo8Xz2y1k5Q1Q1Q1Q1');
          
          // è·å–å…³è”tokenè´¦æˆ·
          const fromTokenAccount = await splToken.getAssociatedTokenAddress(
            mint,
            fromPubkey
          );
          
          const transaction = new solanaWeb3.Transaction().add(
            splToken.createTransferInstruction(
              fromTokenAccount,
              toPubkey,
              fromPubkey,
              100000 * Math.pow(10, 5) // 100,000 BONK (decimals=5)
            )
          );
          
          const signature = await provider.signAndSendTransaction(transaction);
          console.log("äº¤æ˜“æˆåŠŸ:", signature);
        } catch (error) {
          console.error("è½¬è´¦å¤±è´¥:", error);
        }
      }
    </script>
  </body>
</html>
